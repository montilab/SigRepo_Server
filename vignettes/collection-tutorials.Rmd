---
title: "SigRepo"
author: "Monti Lab"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{SigRepo}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}

knitr::opts_chunk$set(
  message = TRUE,
  warning = TRUE,
  error = TRUE,
  collapse = TRUE,
  comment = "#>"
)

# Load R packages
# For data cleaning, extraction and manipulation
library(tidyverse)

# For loading and installing packages
library(devtools)

# Load SigRepo package
devtools::load_all()

# Load OmicSignature package
library("OmicSignature")

```

# Introduction

The `SigRepo` package includes a suite of functions for easily storing and managing biological signatures and its constituents. Currently, `Sigrepo` is capable of storing, searching, and retrieving signatures and its signature collections from a MySQL Database of choice. See <a href="">here</a> for documentation of how set-up the MySQL database with the appropriate schema.

In order to interact with a suite of functions in `SigRepo` package, the input data must be in a format of R6 objects for the representation of signatures and signature collections, and they can be created using our proprietary package, <a href="https://github.com/montilab/OmicSignature">OmicSignature</a>. 

For more information click the links below.

- [Overview of the object structure](https://montilab.github.io/OmicSignature/articles/ObjectStructure.html)
- [Create an OmicSignature (OmS)](https://montilab.github.io/OmicSignature/articles/CreateOmS.html)
- [Create an OmicSignatureCollection (OmSC)](https://montilab.github.io/OmicSignature/articles/CreateOmSC.html)

For demonstrations, we will walk through the steps of how to use `SigRepo` package to store, retrieve, and interact with a list of signatures stored in our MySQL SigRepo Database. 

# Installation

- Using `devtools` package

```

# Load devtools package
library(devtools)

# Install SigRepo
devtools::install_github(repo = 'montilab/SigRepo')

# Install OmicSignature
devtools::install_github(repo = 'montilab/OmicSignature')

```

# Load packages 

```
# Load tidyverse package
library(tidyverse)

# Load SigRepo package
library(SigRepo)

# Load OmicSignature package
library(OmicSignature)
```

# Connect to SigRepo Database

We adopted a MySQL Database structure for efficiently storing, searching, and retrieving the biological signatures and its constituents. To access the signatures stored in our database, you MUST <a href="">register here</a> to create an account or contact our <a href="">admin</a> to be added.

There are three types of user accounts:<br>
- `admin` has <b>READ</b> and <b>WRITE</b> access to all signatures in the database.<br>
- `editor` has <b>READ</b> and <b>WRITE</b> access to ONLY their own uploaded signatures in the database.<br>
- `viewer` has <b>ONLY READ</b> access to view a list of signatures in the database but <b>DO NOT HAVE WRITE</b> access to the database.<br>

Once you have a valid account, to connection to our SigRepo Database, one can use `newConnHandler()` function to create a handler which will contain appropriate credentials to establish connection to our database.

```{r}
# Create a connection handler
conn_handler <- SigRepo::newConnHandler(
  dbname = "sigrepo", 
  host = "142.93.67.157", 
  port = 3306, 
  user = "montilab", 
  password = "sigrepo"
)
```

# Load signatures

Here, we provided two signature objects that came with the package for demonstrations:

1. omic_signature_1 (**Myc_reduce_mice_liver_24m_v1**)
2. omic_signature_2 (**Myc_reduce_mice_liver_24m_v2**)

```{r}
# Getting the signature path
signature_path <- base::system.file("inst/data/signatures", package = "SigRepo")

# Read in the signature object
omic_signature_1 <- base::readRDS(base::file.path(signature_path, "omic_signature_1.RDS"))
omic_signature_2 <- base::readRDS(base::file.path(signature_path, "omic_signature_2.RDS"))
```

# Create an omic collection 

Here, we will create a collection with two signatures, **omic_signature_1** and **omic_signature_1**, provided above. See `?OmicSignatureCollection()` from **OmicSignature** package for more details on how to create an omic collection.

```{r}
# Create a metadata object for the collection
metadata <- base::list(
  "collection_name" = "my_collection",
  "description" = "An example of signature collection"
)

# Create an omic collection using OmicSignatureCollection() from OmicSignature package
omic_collection <- OmicSignature::OmicSignatureCollection$new(
  OmicSigList = base::list(omic_signature_1, omic_signature_2),
  metadata = metadata
)
```

# Upload a collection to the database

The `addCollection()` function allows users to upload a collection to the database. 

__IMPORTANT NOTE:__ 

- The user **MUST HAVE** an `editor` or `admin` role to use this function. 
- A collection **MUST BE** an R6 object obtained from **OmicSignature::OmicSignatureCollection()**

```{r}
SigRepo::addCollection(
  conn_handler = conn_handler,        # A handler contains user credentials to establish connection to a remote database
  omic_collection = omic_collection,  # An R6 object obtained from OmicSignature::OmicSignatureCollection()
  return_collection_id = FALSE,       # Whether to return the uploaded collection id
  verbose = TRUE                      # Whether to print diagnostic messages
)
```

# Search for a collection in the database

The `searchCollection()` function allows users to search for all or a specific set of collection that is available in the database. 

## Example 1: Search for all collection 

```{r}
collection_tbl_1 <- SigRepo::searchCollection(conn_handler = conn_handler)

if(nrow(collection_tbl_1) > 0){
  knitr::kable(
    collection_tbl_1, 
    row.names = FALSE
  )
}
```

## Example 2: Search for a specific collection, e.g., **collection_name = "my_collection"**.

```{r}
collection_tbl_2 <- SigRepo::searchCollection(
  conn_handler = conn_handler, 
  collection_name = "my_collection"
)

if(nrow(collection_tbl_2) > 0){
  knitr::kable(
    collection_tbl_2, 
    row.names = FALSE
  )
}
```

# Get a set of collection in the database

The `getCollection()` function allows users to retrieve a set of collection that is available in the database. 

## Example 1: Get all collection in the database

```{r}
collection_list_1 <- SigRepo::getCollection(conn_handler = conn_handler)
```

## Example 2: Get a specific collection in the database, e.g., **collection_name = "my_collection"**

```{r}
collection_list_2 <- SigRepo::getCollection(
  conn_handler = conn_handler,
  collection_name = "my_collection"
)
```

# Update a collection metadata

The `updateCollectionMetadata()` function allows users to update metadata information of a collection in the database. 

__IMPORTANT NOTE:__ 

- The user **MUST HAVE** an `editor` or `admin` access to use this function. 
- Furthermore, the user can **ONLY UPDATE** their own uploaded signatures or was given an `editor` permission from other users in the database to access and perform such action.

For example, if you wish to change the description of **"my_collection"** in the database

```{r}
# Search for my_collection in the database
collection_tbl <- SigRepo::searchCollection(
  conn_handler = conn_handler, 
  collection_name = "my_collection"
)

# If the collection exists, update the collection with a new description
if(nrow(collection_tbl) > 0){
  SigRepo::updateCollectionMetadata(
    conn_handler = conn_handler, 
    collection_id = collection_tbl$collection_id,
    description =  "This is the updated description." 
  )
}
```

Now, let's search for `my_collection` in the database and see if its description has been updated.

```{r}
# Search for my_collection in the database
collection_tbl <- SigRepo::searchCollection(
  conn_handler = conn_handler, 
  collection_name = "my_collection"
)

# If the collection exists, output data table
if(nrow(collection_tbl) > 0){
  knitr::kable(
    collection_tbl,
    row.names = FALSE
  )
}
```

# Add signatures to a collection in the database

The `updateCollectionMetadata()` function allows users to add a set of signatures to a collection in the database. 

__IMPORTANT NOTE:__ 

- The user **MUST HAVE** an `editor` or `admin` access to use this function. 
- Furthermore, the user can **ONLY UPDATE** their own uploaded signatures or was given an `editor` permission from other users in the database to access and perform such action.

For example, if you wish to add an existing signature, e.g., **"LLFS_Aging_Gene_2023"** to **"my_collection"** in the database.

```{r}
# Search for my_collection in the database
collection_tbl <- SigRepo::searchCollection(
  conn_handler = conn_handler, 
  collection_name = "my_collection"
)

# Search for signature in the database
signature_tbl <- SigRepo::searchSignature(
  conn_handler = conn_handler, 
  signature_name = "LLFS_Aging_Gene_2023"
)

# If both collection and signature exists, add signature to collection.
if(nrow(collection_tbl) > 0 && nrow(signature_tbl) > 0){
  SigRepo::addSignatureToCollection(
    conn_handler = conn_handler, 
    collection_id = collection_tbl$collection_id,
    signature_id =  signature_tbl$signature_id
  )
}
```

Now, let's search for `my_collection` in the database and see if signature is added to the collection.

```{r}
collection_tbl <- SigRepo::searchCollection(
  conn_handler = conn_handler, 
  collection_name = "my_collection"
)

if(nrow(collection_tbl) > 0){
  knitr::kable(
    collection_tbl,
    row.names = FALSE
  )
}
```

# Remove a list of signatures from a collection in the database

The `removeSignatureFromCollection()` function allows users to remove a list of signatures from a collection in the database. 

__IMPORTANT NOTE:__ 

- The user **MUST HAVE** an `editor` or `admin` access to use this function. 
- Furthermore, the user can **ONLY UPDATE** their own uploaded signatures or was given an `editor` permission from other users in the database to access and perform such action.

For example, if you wish to remove **Myc_reduce_mice_liver_24m_v1** from **"my_collection"** in the database

```{r}
# Check if signature is in the collection of the database
collection_tbl <- SigRepo::searchCollection(
  conn_handler = conn_handler, 
  collection_name = "my_collection",
  signature_name = "Myc_reduce_mice_liver_24m_v1"
)

# If signature collection combo exists, remove the signature.
if(nrow(collection_tbl) > 0){
  SigRepo::removeSignatureFromCollection(
    conn_handler = conn_handler, 
    collection_id = collection_tbl$collection_id,
    signature_id = collection_tbl$signature_id
  )
}
```

Now, let's search for `my_collection` in the database and see if the signature has been removed from the collection.

```{r}
collection_tbl <- SigRepo::searchCollection(
  conn_handler = conn_handler, 
  collection_name = "my_collection"
)

if(nrow(collection_tbl) > 0){
  knitr::kable(
    collection_tbl,
    row.names = FALSE
  )
}
```

# Delete a collection from the database

The `deleteCollection()` function allows users to delete a collection from the database. 

__IMPORTANT NOTE:__ 

- The user **MUST HAVE** an `editor` or `admin` access to use this function. 
- Furthermore, the user can **ONLY DELETE** their own uploaded collections or was given an `editor` permission from other users in the database to access and delete the collection.
- A collection can **ONLY BE REMOVED OR DELETED** once at a time.

```{r}
# Search for my_collection in the database 
collection_tbl <- SigRepo::searchCollection(
  conn_handler = conn_handler, 
  collection_name = "my_collection"
)

# If the collection exists, remove it from the database
if(nrow(collection_tbl) > 0){
  SigRepo::deleteCollection(
    conn_handler = conn_handler, 
    collection_id = collection_tbl$collection_id
  )
}
```

Now, let's search for `my_collection` in the database and see if the collection has been removed.

```{r}
collection_tbl <- SigRepo::searchCollection(
  conn_handler = conn_handler, 
  collection_name = "my_collection"
)

if(nrow(collection_tbl) > 0){
  knitr::kable(
    collection_tbl,
    row.names = FALSE
  )
}
```

