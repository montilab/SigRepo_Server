---
title: "SigRepo Function Suite"
author: "Monti Lab"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}

knitr::opts_chunk$set(
  message = FALSE,
  collapse = TRUE,
  comment = "#>"
)

# Load R packages
# For data cleaning, extraction and manipulation
library(tidyverse)

# For loading and installing packages
library(devtools)

# Load SigRepo package
devtools::load_all()

# Load OmicSignature package
devtools::load_all("OmicSignature")

```

# Introduction

The `SigRepo` package is a suite of functions for storing and managing biological signatures and its constituents. Currently, the signatures and its collection uploaded from the `SigRepo` package will be stored on our MySQL Database for efficient storage, search, and retrieval of the signatures.

The basis of interacting with a suite of functions in `SigRepo` package requires data in format of R6 objects for the representation of signatures and signature collections from our proprietary package, <a href="https://github.com/montilab/OmicSignature">OmicSignature</a>. For more information click the links below.

- [Overview of the object structure](https://montilab.github.io/OmicSignature/articles/ObjectStructure.html)
- [Create an OmicSignature (OmS)](https://montilab.github.io/OmicSignature/articles/CreateOmS.html)
- [Create an OmicSignatureCollection (OmSC)](https://montilab.github.io/OmicSignature/articles/CreateOmSC.html)

# Installation

- Using `devtools` package

```

# Load devtools package
library(devtools)

# Install SigRepo
devtools::install_github(repo = 'montilab/SigRepo')

# Install OmicSignature
devtools::install_github(repo = 'montilab/OmicSignature')

```

# SigRepo Database

To easily We adopted a MySQL Database for efficiently storing, searching, and retrieving the biological signatures and its constituents. To connection to our database, one can use the `newConnHandler()` function to create a handler which contains appropriate credentials to establish connection to our SigRepo Database.

```{r}

conn_handler <- SigRepo::newConnHandler(
  dbname = Sys.getenv("DBNAME"), 
  host = Sys.getenv("HOST"), 
  port = as.integer(Sys.getenv("PORT")), 
  user = Sys.getenv("USER"), 
  password = Sys.getenv("PASSWORD")
)

```

# Load Signatures

Here, we provided three different signature objects to be stored in the SigRepo database:

1. LLFS_Transcriptomic_AGS_OmS
2. LLFS_Transcriptomic_EOA_OmS
3. LLFS_Transcriptomic_EOAU_OmS

```{r}

# Getting the signature path
signature_path <- base::system.file("inst/data/signatures", package = "SigRepo")

# Read in the signature object
LLFS_Transcriptomic_AGS_OmS <- base::readRDS(file.path(signature_path, "LLFS_Transcriptomic_AGS_OmS.rds"))
LLFS_Transcriptomic_EOA_OmS <- base::readRDS(file.path(signature_path, "LLFS_Transcriptomic_EOA_OmS.rds"))
LLFS_Transcriptomic_EOAU_OmS <- base::readRDS(file.path(signature_path, "LLFS_Transcriptomic_EOAU_OmS.rds"))

```

# Adding a Signature

The function `addSignature()` allows the user to upload a signature to the database. The user must have editor or admin access to use this function. The Omic Signature object format is the *required* format.


Below is code to upload a signature to the database


```{r}
#SigRepo::addSignature(connection object, omic signature object)

# Example Code

# SigRepo::addSignature(conn_handler, OmS_SUM_AhR)
# SigRepo::addSignature(conn_handler, OmS_SUM_CYP)
# SigRepo::addSignature(conn_handler, OmS_MDA_AhR)
# SigRepo::addSignature(conn_handler, OmS_MDA_CYP)
SigRepo::addSignature(conn_handler, OmS_LLFS_AGS)

```

# Searching for a signature

The function `searchSignature()` allows the user to search for a signature in the database. There are several optional parameters that the user can search by. The user must have viewing access to that signature in order to retrieve view it. The OmicSignature object is *not required*, only the name.

 Below is the code to search a signature 

```{r}
#SigRepo::searchSignature(connection object, signature name, ...)

# Example Code

# SigRepo::searchSignature(conn_handler, 'OmS_SUM_Ahr')
# SigRepo::searchSignature(conn_handler, 'OmS_SUM_CYP')
# SigRepo::searchSignature(conn_handler, 'OmS_MDA_AhR')
# SigRepo::searchSignature(conn_handler, 'OmS_MDA_CYP')
SigRepo::searchSignature(conn_handler)



```

# Getting a signature

The function `getSignature` allows the user to retrieve a signature object from the database. By default, the owner of that signature will be able to retrieve their signature regardless of privileges. However, if the signature is by another collaborator, the user must have access to that signature. 


```{r}
#SigRepo::getSignature(connection object, signature name)
signatures <- SigRepo::getSignature(conn_handler)
```

```{r}
LLFS_sig <- SigRepo::getSignature(conn_handler, signature_name = "LLFS_Aging_Gene_2023")
```

<!-- # Update a signature -->

The function `updateSignature` allows the user to update a signature in the sigrepo database. For example the adjusted pvalues in the previous OmicSignature object are incorrect, and you wish to replace the object with the correct values, you would use this function.

-

Below is the code to update the example signature with a new one, in this instance, the signature, OmS_SUM_AhR.rds has its metadata updated. Below is code to ho

```{r}

# Using the OmicSignature Package
metadata_SUM_AhR_revised <- OmicSignature::createMetadata(
  signature_name = "AhR knockdown in breast cancer cell line",
  organism = "Homo sapiens",
  assay_type = "transcriptomics",
  phenotype = "AhR knockdown",
  sample_type = "SUM-149PT cell",
  direction_type = "bi-directional",
  platform = "GPL17930",
  covariates = "none",
  year = 2017, # year was changed from 2016 to 2017
  keywords = c("breast cancer", "AhR knockdown"),
  description = "Profiles of the transcriptional response of AhR knockdown in breast cancer cell lines",
  adj_p_cutoff = "0.01"
)

# create the updated OmicSignature object
OmS_SUM_AhR <- OmicSignature::OmicSignature$new(
  signature = sig_SUM_AhR,
  metadata = metadata_SUM_AhR_revised,
  difexp = difexp_SUM_Ahr
)

# updating the signature
# SigRepo::updateSignature(connection object, new signature object, old signature name)
SigRepo::updateSignature(conn_handler, OmS_SUM_AhR, 'OmS_Sum_AhR')

```



# Deleting a signature

The function `deleteSignature` allows he user to delete a signature from the database. The signature MUST be that users own signature OR the user must have admin access within SigRepo.

```{r}

SigRepo::deleteSignature(conn_handler = conn_handler, signature_id = 'OmS_LLFS_AGS')

```

