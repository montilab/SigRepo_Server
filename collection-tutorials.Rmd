---
title: "SigRepo Function Suite"
author: "Monti Lab"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}

knitr::opts_chunk$set(
  message = TRUE,
  warning = FALSE,
  error = TRUE,
  collapse = TRUE,
  comment = "#>"
)

# Load R packages
# For data cleaning, extraction and manipulation
library(tidyverse)

# For loading and installing packages
library(devtools)

# Load SigRepo package
devtools::load_all()

# Load OmicSignature package
devtools::load_all("OmicSignature")

```

# Introduction

The `SigRepo` package includes a suite of functions for easily storing and managing biological signatures and its constituents. Currently, `Sigrepo` is capable of storing, searching, and retrieving signatures and its signature collections from a MySQL Database of choice. See <a href="">here</a> for documentation of how set-up the MySQL database with the appropriate schema.

In order to interact with a suite of functions in `SigRepo` package, the input data must be in a format of R6 objects for the representation of signatures and signature collections, and they can be created using our proprietary package, <a href="https://github.com/montilab/OmicSignature">OmicSignature</a>. 

For more information click the links below.

- [Overview of the object structure](https://montilab.github.io/OmicSignature/articles/ObjectStructure.html)
- [Create an OmicSignature (OmS)](https://montilab.github.io/OmicSignature/articles/CreateOmS.html)
- [Create an OmicSignatureCollection (OmSC)](https://montilab.github.io/OmicSignature/articles/CreateOmSC.html)

For demonstrations, we will walk through the steps of how to use `SigRepo` package to store, retrieve, and interact with a list of signatures stored in our MySQL SigRepo Database. 

# Installation

- Using `devtools` package

```

# Load devtools package
library(devtools)

# Install SigRepo
devtools::install_github(repo = 'montilab/SigRepo')

# Install OmicSignature
devtools::install_github(repo = 'montilab/OmicSignature')

```

# Connect to SigRepo Database

We adopted a MySQL Database structure for efficiently storing, searching, and retrieving the biological signatures and its constituents. To access the signatures stored in our database, you MUST <a href="">register here</a> to create an account or contact our <a href="">admin</a> to be added.

There are three types of user accounts:<br>
- `admin` has <b>READ</b> and <b>WRITE</b> access to all signatures in the database.<br>
- `editor` has <b>READ</b> and <b>WRITE</b> access to ONLY their own uploaded signatures in the database.<br>
- `viewer` has <b>ONLY READ</b> access to view a list of signatures in the database but <b>DO NOT HAVE WRITE</b> access to the database.<br>

Once you have a valid account, to connection to our SigRepo Database, one can use `newConnHandler()` function to create a handler which will contain appropriate credentials to establish connection to our database.

```{r}
# Create a connection handler
conn_handler <- SigRepo::newConnHandler(
  dbname = Sys.getenv("DBNAME"), 
  host = Sys.getenv("HOST"), 
  port = as.integer(Sys.getenv("PORT")), 
  user = Sys.getenv("USER"), 
  password = Sys.getenv("PASSWORD")
)
```

# Load Signatures

Here, we provided two signature objects that came with the package for demonstrations:

1. omic_signature_1
2. omic_signature_2

```{r}
# Getting the signature path
signature_path <- base::system.file("inst/data/signatures", package = "SigRepo")

# Read in the signature object
omic_signature_1 <- base::readRDS(file.path(signature_path, "omic_signature_1.RDS"))
omic_signature_2 <- base::readRDS(file.path(signature_path, "omic_signature_2.RDS"))

```

# Create a signature collection 

Here, we will create a signature collection object using **OmicSignature** package

```{r}
# Create collection metadata
metadata <- list(
  "collection_name" = "Example_Collection",
  "description" = "An example of signature collection",
  "author" = "me"
)

omic_collection <- OmicSignature::OmicSignatureCollection$new(
  OmicSigList = list(omic_signature_1, omic_signature_2),
  metadata = metadata
)
```

# Upload a collection

The function `addSignatureCollection()` allows the user to upload a collection to the database. 

__IMPORTANT NOTE:__ The user must have `editor` or `admin` access to use this function. 

```{r}

# Add collection to database
SigRepo::addSignatureCollection(
  conn_handler = conn_handler, 
  omic_collection = omic_collection
)

```

# Search for a collection

The function `searchCollection()` allows the user to search for all or a specific signature that is available in the database. 

- Search for all signatures 

```{r}

knitr::kable(
  SigRepo::searchCollection(
    conn_handler = conn_handler
  ), 
  row.names = FALSE
)

```

- Search for a specific collection, e.g., **"Example_Collection"**, in the database

```{r}

knitr::kable(
  SigRepo::searchCollection(
    conn_handler = conn_handler, 
    collection_name = "Example_Collection"
  ),
  row.names = FALSE
)

```


# Update a collection 

The function `updateCollection()` allows the user to update a collection in the sigrepo database. 

__IMPORTANT NOTE:__ The user must have `editor` or `admin` access to use this function. Furthermore, the user can **ONLY UPDATE** their own uploaded signatures or was given the `editor` permission from other users to do so.

For example, if you wish to replace the description of **"Example_Collection"** in the database

```{r}

# Search for Example_Collection in the database
collection_tbl <- SigRepo::searchCollection(
  conn_handler = conn_handler, 
  collection_name = "Example_Collection"
)

# Get the collection id
collection_id <- unique(collection_tbl$collection_id)

# Updating the collection with a new description
SigRepo::updateCollectionMetadata(
  conn_handler = conn_handler, 
  collection_id = collection_id,
  description =  "This is the updated description." 
)

```

```{r}

knitr::kable(
  SigRepo::searchCollection(
    conn_handler = conn_handler, 
    collection_name = "Example_Collection"
  ),
  row.names = FALSE
)

```


# Delete a collection

The function `deleteCollection()` allows the user to delete a collection from the database. 

__IMPORTANT NOTE:__ The user must have `editor` or `admin` access to use this function. Furthermore, the user can **ONLY DELETE** their own uploaded collections or was given the `editor` permission from other users to do so.

```{r}

# Search for Example_Collection in the database 
collection_tbl <- SigRepo::searchCollection(
  conn_handler = conn_handler, 
  collection_name = "Example_Collection"
)

# Get the collection id
collection_id <- unique(collection_tbl$collection_id)

# Remove collection from the database
SigRepo::deleteCollection(
  conn_handler = conn_handler, 
  collection_id = collection_id
)

```

